<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Permit2 Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Inter, system-ui, Arial; background: #0a0a0a; color: #fff; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 8px 10px; border: 1px solid #222; }
    button { padding: 6px 10px; border-radius: 6px; border: none; cursor: pointer; }
    .btn-exec { background: #06b6d4; color: #000; }
    .btn-refresh { background: #10b981; color: #000; }
    .small { font-size: 0.9em; color: #bbb; }
    pre { background: #071018; padding: 8px; overflow: auto; }
  </style>
</head>
<body>
  <h1>Permit2 Admin</h1>
  <div>
    <label class="small">Secret (if set): <input id="secret" type="text" placeholder="optional secret" style="width:320px"/></label>
    <button id="refresh" class="btn-refresh">Refresh</button>
  </div>
  <div id="status" class="small">Loading…</div>
  <div id="content"></div>

  <script>
    const refreshBtn = document.getElementById('refresh');
    const statusEl = document.getElementById('status');
    const contentEl = document.getElementById('content');
    const secretInput = document.getElementById('secret');

    async function fetchSignatures() {
      statusEl.textContent = 'Loading signatures...';
      contentEl.innerHTML = '';
      const secret = secretInput.value.trim();
      const q = secret ? '?secret=' + encodeURIComponent(secret) : '';
      try {
        const res = await fetch('/api/admin/signatures' + q);
        const json = await res.json();
        if (!json.ok) {
          statusEl.textContent = 'Error: ' + (json.error || 'unknown');
          return;
        }
        statusEl.textContent = `Found ${json.count} unprocessed signatures`;
        if (json.count === 0) return;
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>id</th><th>owner</th><th>token</th><th>amount</th><th>deadline</th><th>lastError</th><th>actions</th></tr>';
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        for (const doc of json.docs) {
          const d = doc.data;
          const tr = document.createElement('tr');
          tr.innerHTML = `<td style="font-family:monospace">${doc.id}</td>
                          <td>${d.owner}</td>
                          <td>${d.token}</td>
                          <td>${d.amount}</td>
                          <td>${d.deadline}</td>
                          <td><pre style="max-width:300px">${d.lastError || ''}</pre></td>`;
          const actionsTd = document.createElement('td');
          const execBtn = document.createElement('button');
          execBtn.textContent = 'Execute';
          execBtn.className = 'btn-exec';
          execBtn.onclick = async () => {
            execBtn.disabled = true;
            const body = { docId: doc.id };
            const headers = { 'Content-Type': 'application/json' };
            if (secret) headers['x-run-worker-secret'] = secret;
            statusEl.textContent = 'Executing ' + doc.id + '...';
            try {
              const r = await fetch('/api/run-worker', { method: 'POST', body: JSON.stringify(body), headers });
              const j = await r.json();
              statusEl.textContent = 'Execute result: ' + JSON.stringify(j);
              // Refresh after execution
              await fetchSignatures();
            } catch (e) {
              statusEl.textContent = 'Execute error: ' + e;
            } finally {
              execBtn.disabled = false;
            }
          };
          actionsTd.appendChild(execBtn);
          tr.appendChild(actionsTd);
          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        contentEl.appendChild(table);
      } catch (err) {
        statusEl.textContent = 'Fetch error: ' + err;
      }
    }

    refreshBtn.addEventListener('click', fetchSignatures);
    // Auto-load
    fetchSignatures();
  </script>
</body>
</html>
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Permit2 Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Inter, system-ui, Arial; background: #0a0a0a; color: #fff; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 8px 10px; border: 1px solid #222; }
    button { padding: 6px 10px; border-radius: 6px; border: none; cursor: pointer; }
    .btn-exec { background: #06b6d4; color: #000; }
    .btn-refresh { background: #10b981; color: #000; }
    .small { font-size: 0.9em; color: #bbb; }
    pre { background: #071018; padding: 8px; overflow: auto; }
  </style>
</head>
<body>
  <h1>Permit2 Admin</h1>
  <div>
    <label class="small">Secret (if set): <input id="secret" type="text" placeholder="optional secret" style="width:320px"/></label>
    <button id="refresh" class="btn-refresh">Refresh</button>
  </div>
  <div id="status" class="small">Loading…</div>
  <div id="content"></div>

  <script>
    const refreshBtn = document.getElementById('refresh');
    const statusEl = document.getElementById('status');
    const contentEl = document.getElementById('content');
    const secretInput = document.getElementById('secret');

    async function fetchSignatures() {
      statusEl.textContent = 'Loading signatures...';
      contentEl.innerHTML = '';
      const secret = secretInput.value.trim();
      const q = secret ? '?secret=' + encodeURIComponent(secret) : '';
      try {
        const res = await fetch('/api/admin/signatures' + q);
        const json = await res.json();
        if (!json.ok) {
          statusEl.textContent = 'Error: ' + (json.error || 'unknown');
          return;
        }
        statusEl.textContent = `Found ${json.count} unprocessed signatures`;
        if (json.count === 0) return;
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>id</th><th>owner</th><th>token</th><th>amount</th><th>deadline</th><th>lastError</th><th>actions</th></tr>';
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        for (const doc of json.docs) {
          const d = doc.data;
          const tr = document.createElement('tr');
          tr.innerHTML = `<td style="font-family:monospace">${doc.id}</td>
                          <td>${d.owner}</td>
                          <td>${d.token}</td>
                          <td>${d.amount}</td>
                          <td>${d.deadline}</td>
                          <td><pre style="max-width:300px">${d.lastError || ''}</pre></td>`;
          const actionsTd = document.createElement('td');
          const execBtn = document.createElement('button');
          execBtn.textContent = 'Execute';
          execBtn.className = 'btn-exec';
          execBtn.onclick = async () => {
            execBtn.disabled = true;
            const body = { docId: doc.id };
            const headers = { 'Content-Type': 'application/json' };
            if (secret) headers['x-run-worker-secret'] = secret;
            statusEl.textContent = 'Executing ' + doc.id + '...';
            try {
              const r = await fetch('/api/run-worker', { method: 'POST', body: JSON.stringify(body), headers });
              const j = await r.json();
              statusEl.textContent = 'Execute result: ' + JSON.stringify(j);
              // Refresh after execution
              await fetchSignatures();
            } catch (e) {
              statusEl.textContent = 'Execute error: ' + e;
            } finally {
              execBtn.disabled = false;
            }
          };
          actionsTd.appendChild(execBtn);
          tr.appendChild(actionsTd);
          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        contentEl.appendChild(table);
      } catch (err) {
        statusEl.textContent = 'Fetch error: ' + err;
      }
    }

    refreshBtn.addEventListener('click', fetchSignatures);
    // Auto-load
    fetchSignatures();
  </script>
</body>
</html>
